# CP2K-MD-ANALYSIS

**CP2K-MD-ANALYSIS** is a Python-based analysis toolkit for processing molecular dynamics simulation data generated by CP2K. The project is designed to convert XYZ trajectory files into Python objects and perform detailed analysis on cation behavior at metal surfaces. Analyses include radial distribution functions (RDF), density and coordination number (CN) calculations, water residence time evaluations, and geometric (e.g. opening angle) analyses—all integrated into a comprehensive workflow.

---

## Table of Contents

- [Features](#features)
- [Directory Structure](#directory-structure)
- [Installation](#installation)
- [Usage](#usage)
  - [Data Conversion](#data-conversion)
  - [Analysis and Plotting](#analysis-and-plotting)
- [Code Overview](#code-overview)
  - [Classes and Data Processing](#classes-and-data-processing)
  - [Utility and Plotting Functions](#utility-and-plotting-functions)
- [Examples](#examples)
- [License](#license)

---

## Features

- **XYZ-to-Pickle Conversion:** Convert raw XYZ simulation files to a serialized Python `Simulation` object.
- **Trajectory Processing:** Extract and classify atomic positions (e.g. metal, water, ions, adsorbates) for each simulation frame.
- **Radial Distribution Function (RDF) Analysis:** Compute RDFs between oxygen atoms and ions, with options for smoothing and normalization.
- **Density and Coordination Analysis:** Generate density plots for ions and oxygen near the surface, compare ion densities, compute local (continuous) coordination numbers (CCN) and hollow coordination numbers.
- **Water Residence Time Calculation:** Determine the average lifetime of water molecules within the solvation sphere of selected cations.
- **Geometric Analysis:** Calculate opening angles between ions, water oxygens, and the surface-normal, with aggregated histograms and density insets.
- **Custom Plotting Utilities:** Extensive plotting customization using Matplotlib, including custom legends and inset plots.

---

## Directory Structure

```
CP2K-MD-ANALYSIS/
│
├── data/
│   ├── simulations/
│   │   └── example.pkl         # Example simulation pickle file.
│   └── xyz_files/
│       └── example.xyz         # Example XYZ trajectory file.
│
├── cation_behaviour.ipynb      # Main Jupyter Notebook with analysis and plotting routines.
├── classes.py                  # Contains the Simulation class for processing XYZ files.
├── conversion.py               # Script for converting XYZ files to pickle files.
└── README.md                   # This file.
```

---

## Installation

Ensure you have Python 3.7 or later installed. Install the required packages using pip:

```bash
pip install numpy matplotlib
```

> **Note:** The project uses standard Python libraries for file handling, logging, and data processing (e.g., `pickle`, `logging`, `collections`). Additional dependencies may be required depending on your environment.

---

## Usage

### Data Conversion

To convert an XYZ trajectory file into a pickle file, use the script in `conversion.py`. For example, run:

```bash
python conversion.py
```

This script initializes a `Simulation` object using parameters such as timestep, cell dimensions, and lattice dimensions, then saves the object as a pickle file in the `data/simulations` directory. You can also uncomment and modify simulation identifiers and electrode potential lists as needed.

### Analysis and Plotting

The primary analysis routines are provided in the Jupyter Notebook (`cation_behaviour.ipynb`). The notebook includes:

- Importing and setting up utility functions.
- Calculation of RDFs between oxygen and ions.
- Density plot generation for ions and water near the metal surface.
- Comparison of ion density curves (with and without adsorbates).
- Computation of continuous and hollow coordination numbers (CCN) versus distance from the surface.
- Water residence time calculations.

To run the analyses:
1. Open `cation_behaviour.ipynb` in Jupyter Notebook or JupyterLab.
2. Execute cells sequentially to process simulation data and generate plots.

---

## Code Overview

### Classes and Data Processing

- **`Simulation` Class (in `classes.py`):**
  - Reads and processes XYZ files.
  - Extracts simulation metadata, including cell dimensions, lattice structure, and electrode potential.
  - Classifies atoms into categories (metal, water oxygen/hydrogen, ions, and adsorbates) using a combination of automatic detection and user prompts.
  - Processes trajectory data frame-by-frame to compute properties like metal surface z-coordinate and water center-of-mass.

### Utility and Plotting Functions

- **Utility Functions (in `conversion.py` and within the notebook):**
  - Color blending, logging setup, and safe attribute retrieval.
  - File I/O functions to load and save `Simulation` objects using pickle.
  - Data processing routines for computing histograms, smoothing data, and applying periodic boundary conditions.

- **Analysis Functions:**
  - **RDF Calculation:** Functions to compute single-frame RDFs and average RDFs across simulation frames.
  - **Density and Coordination Analysis:** Functions for computing and plotting ion and oxygen density profiles, including both continuous and hollow coordination numbers.
  - **Water Residence Time:** Computes the duration water molecules remain within the solvation sphere of a specified cation.
  - **Opening Angle Distribution:** Calculates and plots the angular distribution between ions, water oxygens, and the surface-normal, with region-based grouping and density insets.

- **Plotting Utilities:**
  - Custom plotting functions (`custom_plot`) provide extensive options for figure customization, legends, axis labels, and inset plots.

---

## Examples

- **XYZ to Pickle Conversion:**

  Run the `conversion.py` script to convert your XYZ files to pickle format. Adjust the parameters (e.g., timestep, cell dimensions) as necessary.

- **RDF and Density Analysis:**

  Open `cation_behaviour.ipynb` to execute various analyses:
  - Use `plot_ion_oxygen_rdf()` to aggregate and visualize RDF curves for different ion types.
  - Run `plot_density()` or `compare_ion_densities()` to generate density plots of ions and water.
  - Use `plot_ccn_vs_distance()` and `plot_hollow_cn_vs_distance()` to analyze coordination numbers versus distance from the metal surface.
  - Finally, run `compute_water_residence_time()` to evaluate water molecule lifetimes in the solvation sphere.

Each analysis function is well-documented within the code with usage instructions and parameter descriptions.

---

## License

This project is provided "as is" without warranty of any kind. Please refer to the LICENSE file for further details.

---

For further questions or contributions, please open an issue or submit a pull request on the project's repository.

Happy Analyzing!

